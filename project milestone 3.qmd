---
title: "Project Milestone 3"
format: html
editor: visual
---

## **Milestone #3 Details**

#### **For Scenario 1: Infectious disease outbreak (simulated) in California - 2023**

The sim_novelid_CA.csv file and sim_novelid_LACounty.csv file together represent simulated morbidity for the entire state of California. While it’s certainly possible for data from different sources to adhere to a format standard, one of the challenges of working with secondary data is that it often does not work out that way. Therefore to prepare each dataset (milestone #3) so that they can be combined into one, whole state, dataset you will need to do the following:

-   Morbidity datasets (from CA and LA County)

    -   Recode column names, values, or formats that are in discordant (dates, etc)

    -   Combine morbidity datasets into a single dataset

    -   Select demographic and geographic strata (s) of interest

    -   Aggregate the data into a new dataframe to include only one row per strata of interest

-   Population dataset

    -   Recode values to be consistent with morbidity datasets so they can be joined

    -   Select demographic or geographic strata(s) of interest

    -   Create a rate metric and summarize to include only one row per strata of interest

For all scenarios, please turn in an html document created from an Rmd or Qmd with the following components:

-   Subset rows or columns, as needed

-   Create new variables needed for analysis (minimum 2)

    -   New variables should be created based on existing columns; for example

        -   Calculating a rate

        -   Combining character strings

        -   Aggregation

-   Clean variables needed for analysis (minimum 2)

    -   Examples

        -   Recode invalid values

        -   Handle missing data

        -   Recode categories

-   Data re-structured as needed (aggregated/summarized and/or pivoted)

-   Data dictionary based on clean dataset (minimum 4 data elements), including:

    -   Variable name

    -   Data type

    -   Description

-   One or more tables with descriptive statistics for 4 data elements

-   Html output that is professionally prepared for presentation

    -   Only the necessary information is outputted (you should suppress, for example, entire data frame outputs)

    -   Use of headers and sub headers to create an organized document

```{r}
#load in datasets/libraries
library(tidyverse)
library(janitor)
ca_pop <- read_csv("ca_pop_2023.csv", 
                   na = c("NA", "N/A", "", "null", "-"))
sim_CA <- read_csv("sim_novelid_CA.csv", 
                   na = c("NA", "N/A", "", "null", "-"))
sim_LA <- read_csv("sim_novelid_LACounty.csv", 
                   na = c("NA", "N/A", "", "null", "-"))

```

Morbidity datasets (from CA and LA County)

-   Recode column names, values, or formats that are in discordant (dates, etc)

```{r}
sim_CA <- sim_CA %>% clean_names()
sim_LA <- sim_LA %>% clean_names()
```

```{r}

sim_LA <- sim_LA %>%
  rename(dt_diagnosis = dt_dx,
    age_cat = age_category,
    race_ethnicity = race_eth,
    new_infections = dx_new,
    cumulative_infected = infected_cumulative,
    new_unrecovered = unrecovered_new,
    cumulative_unrecovered = unrecovered_cumulative,
    new_severe = severe_new,
    cumulative_severe = severe_cumulative)

```

```{r}
sim_CA <- sim_CA %>%
  mutate(dt_diagnosis = as.Date(dt_diagnosis))

sim_LA <- sim_LA %>%
  mutate(dt_diagnosis = as.Date(dt_diagnosis, format = "%d%b%Y"))
```

```{r}
sim_CA <- sim_CA %>%
  mutate(
    race_ethnicity = case_when(
      race_ethnicity == 1 ~ "White, Non-Hispanic",
      race_ethnicity == 2 ~ "Black, Non-Hispanic",
      race_ethnicity == 3 ~ "American Indian or Alaska Native, Non-Hispanic",
      race_ethnicity == 4 ~ "Asian, Non-Hispanic",
      race_ethnicity == 5 ~ "Native Hawaiian or Pacific Islander, Non-Hispanic",
      race_ethnicity == 6 ~ "Multiracial (two or more of above races), Non-Hispanic",
      race_ethnicity == 7 ~ "Hispanic (any race)",
      TRUE ~ NA_character_))

```

```{r}
names(sim_CA)
```

```{r}
names(sim_LA)

```

```{r}
sim_LA <- sim_LA %>%
  select(-dt_report)
```

```{r}
sim_LA <- sim_LA %>%
  mutate(county = "Los Angeles County")
```

```{r}
sim_CA <- sim_CA %>%
  mutate(week_of_diagnosis_2023 = time_int %% 100) %>%
  select(-time_int)
```

-   Combine morbidity datasets into a single dataset

```{r}
library(dplyr)
combined_data <- bind_rows(sim_CA, sim_LA)
view(combined_data)
```

```{r}
unique(sim_CA$county)
unique(sim_CA$age_cat)
```

-   Select demographic and geographic strata (s) of interest:

**Demographic group of interest:** Adults aged 65 years and older (≥65 years)\
**Geographic stratum of interest:** San Francisco County

```{r}
data_of_interest <- combined_data %>%
  filter(county == "San Francisco County", age_cat == "65+")
view(data_of_interest)
```

-   Aggregate the data into a new dataframe to include only one row per strata of interest

The stratum of interest included adults aged 65 years and older in San Francisco County. Because the analysis window was fixed to 2023, the variable week_of_diagnosis_2023 was derived from the original time_int to capture incidence across the weeks of follow-up. The data were grouped by sex and race/ethnicity, and new infections, unrecovered, and severe cases were summarized using sums. The proportion of severe cases was then calculated, and the week with the highest number of new infections was identified to highlight the outbreak’s peak intensity.

```{r}
data_of_interest <- data_of_interest %>%
  group_by(sex, race_ethnicity) %>%
  summarise( total_new_infections  = sum(new_infections,  na.rm = TRUE),
    total_new_unrecovered = sum(new_unrecovered, na.rm = TRUE),
    total_new_severe      = sum(new_severe,      na.rm = TRUE),
    peak_new_infections   = max(new_infections,  na.rm = TRUE),
    peak_week_2023        = week_of_diagnosis_2023[which.max(new_infections)],
    .groups = "drop"
  ) %>%
  mutate(pct_severe = if_else( total_new_infections > 0, total_new_severe / total_new_infections, NA_real_))
```

-   Population dataset

    ```{r}
    ca_pop <- ca_pop %>% clean_names()
    ```

    -   Recode values to be consistent with morbidity datasets so they can be joined

    ```{r}
    ca_pop <- ca_pop %>%
      rename(race_ethnicity = race7
        )
    ```

    ```{r}
    ca_pop <- ca_pop %>%
      mutate(
        race_ethnicity = case_when(
          race_ethnicity == "WhiteTE NH" ~ "White, Non-Hispanic",
          race_ethnicity == "Black NH" ~ "Black, Non-Hispanic",
          race_ethnicity == "AIAN NH" ~ "American Indian or Alaska Native, Non-Hispanic",
          race_ethnicity == "Asian NH" ~ "Asian, Non-Hispanic",
          race_ethnicity == "NHPI NH" ~ "Native Hawaiian or Pacific Islander, Non-Hispanic",
          race_ethnicity == "MR NH" ~ "Multiracial (two or more of above races), Non-Hispanic",
          race_ethnicity == "Hispanic" ~ "Hispanic (any race)",
          TRUE ~ NA_character_))
    ```

    -   Select demographic or geogrphic strata(s) of interest

    **Demographic group of interest:** Adults aged 65 years and older (≥65 years)\
    **Geographic stratum of interest:** San Francisco County

    ```{r}
    ca_pop_focus <- ca_pop %>%
      filter(county == "San Francisco", age_cat == "65+")
    ```

    -   Create a rate metric and summarize to include only one row per strata of interest

```{r}
ca_pop_focus <- ca_pop_focus %>%
  group_by(sex, race_ethnicity) %>% 
  summarize(sum_pop = sum(pop, na.rm = TRUE), .groups = "drop")

```

```{r}
library(tibble)
library(knitr)

data_dictionary <- tibble(
  variable_name = names(data_of_interest),
  data_type = sapply(data_of_interest, class),
  description = c(
    "Biological sex of the individual.",
    "Race and ethnicity category.",
    "Total number of new infections reported for that sex and race/ethnicity group.",
    "Total number of cases that remain unrecovered among the new infections.",
    "Total number of new severe cases among the new infections.",
    "Number of new infections recorded during the peak week of 2023.",
    "Week number of 2023 when the infection count reached its peak for the subgroup.",
    "Proportion of new severe cases among all new infections."
  )
)

print(data_dictionary)
```

```{r}
data_plot <- data_of_interest %>%
  mutate(race_ethnicity = reorder(race_ethnicity, total_new_infections))

ggplot(data_plot,
       aes(x = race_ethnicity, y = total_new_infections, fill = sex)) +
  geom_col(position = position_dodge(width = 0.8)) +
  labs(title = "Total New Infections by Race/Ethnicity and Sex",
       x = "Race/Ethnicity", y = "Total New Infections", fill = "Sex") +
  coord_flip() +
  theme_minimal(base_size = 12)
```
