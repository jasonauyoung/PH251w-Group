---
title: "Project Milestone 4 - Group 3 - Juliana, Daniel, Jason"
format: html
editor: visual
---

## **Milestone #4 Objective - Juliana, Daniel, Jason**

**Loading Libraries...**

```{r libraries, warning=FALSE, message=FALSE}
library(tidyverse)
library(janitor)
library(dplyr)
library(knitr)
install.packages("scales")
library(scales)
```

```{r chunk_name, include=FALSE}
ca_pop <- read_csv("ca_pop_2023.csv", 
                   na = c("NA", "N/A", "", "null", "-"))
sim_CA <- read_csv("sim_novelid_CA.csv", 
                   na = c("NA", "N/A", "", "null", "-"))
sim_LA <- read_csv("sim_novelid_LACounty.csv", 
                   na = c("NA", "N/A", "", "null", "-"))

sim_CA <- sim_CA %>% clean_names()
sim_LA <- sim_LA %>% clean_names()

sim_LA <- sim_LA %>%
  rename(dt_diagnosis = dt_dx,
    age_cat = age_category,
    race_ethnicity = race_eth,
    new_infections = dx_new,
    cumulative_infected = infected_cumulative,
    new_unrecovered = unrecovered_new,
    cumulative_unrecovered = unrecovered_cumulative,
    new_severe = severe_new,
    cumulative_severe = severe_cumulative)

sim_CA <- sim_CA %>%
  mutate(dt_diagnosis = as.Date(dt_diagnosis))

sim_LA <- sim_LA %>%
  mutate(dt_diagnosis = as.Date(dt_diagnosis, format = "%d%b%Y"))

sim_CA <- sim_CA %>%
  mutate(
    race_ethnicity = case_when(
      race_ethnicity == 1 ~ "White, Non-Hispanic",
      race_ethnicity == 2 ~ "Black, Non-Hispanic",
      race_ethnicity == 3 ~ "American Indian or Alaska Native, Non-Hispanic",
      race_ethnicity == 4 ~ "Asian, Non-Hispanic",
      race_ethnicity == 5 ~ "Native Hawaiian or Pacific Islander, Non-Hispanic",
      race_ethnicity == 6 ~ "Multiracial (two or more of above races), Non-Hispanic",
      race_ethnicity == 7 ~ "Hispanic (any race)",
      TRUE ~ NA_character_))

sim_LA <- sim_LA %>%
  select(-dt_report)

sim_LA <- sim_LA %>%
  mutate(county = "Los Angeles County")

ca_pop <- ca_pop %>%
  rename(race_ethnicity = race7
    )

ca_pop <- ca_pop %>%
  mutate(county = paste0(county, " County"))
    

ca_pop <- ca_pop %>%
  mutate(
    race_ethnicity = case_when(
      race_ethnicity == "WhiteTE NH" ~ "White, Non-Hispanic",
      race_ethnicity == "Black NH" ~ "Black, Non-Hispanic",
      race_ethnicity == "AIAN NH" ~ "American Indian or Alaska Native, Non-Hispanic",
      race_ethnicity == "Asian NH" ~ "Asian, Non-Hispanic",
      race_ethnicity == "NHPI NH" ~ "Native Hawaiian or Pacific Islander, Non-Hispanic",
      race_ethnicity == "MR NH" ~ "Multiracial (two or more of above races), Non-Hispanic",
      race_ethnicity == "Hispanic" ~ "Hispanic (any race)",
      TRUE ~ NA_character_))

combined_data <- bind_rows(sim_CA, sim_LA)

```

**Data Structures**

```{r}
str(sim_CA)
str(sim_LA)
str(combined_data)
str(ca_pop)
```

**Collapsing Data in Preparation for Aggregation**

```{r}
ca_pop_collapsed <- ca_pop %>%
  mutate(age_cat = case_when(
    age_cat %in% c("0-4", "5-11", "12-17") ~ "0-17",
    age_cat == "18-49" ~ "18-49",
    age_cat == "50-64" ~ "50-64",
    age_cat == "65+"   ~ "65+",
    TRUE ~ NA_character_
  )) %>%
  group_by(county, health_officer_region, sex, race_ethnicity, age_cat) %>%
  summarise(pop = sum(pop), .groups = "drop")

```

**Data Structures of Collapsed Dataset**

```{r}
str(ca_pop_collapsed)
```

# Data Cleaning + Data Structures for Cleaned Data

```{r}
combined_data <- combined_data %>% select(-time_int)
```

```{r}
combined_data <- combined_data %>%
  left_join(ca_pop_collapsed,
            by = c("county", "age_cat", "sex", "race_ethnicity"))
str(combined_data)
```

```{r}
combined_data <- combined_data %>%
  mutate(
    rate_infection = (new_infections / pop) * 100000,
    rate_unrecovered = (new_unrecovered / pop) * 100000,
    rate_severe = (new_severe / pop) * 100000,
    rate_cum_infection = (cumulative_infected / pop) * 100000,
    rate_cum_unrecovered = (cumulative_unrecovered / pop) * 100000,
    rate_cum_severe = (cumulative_severe / pop) * 100000)
str(combined_data)
```

```{r}
combined_data <- combined_data %>%
  mutate(across(starts_with("rate"), ~ round(.x, 2)))

```

# VISUALIZATION #1:

This figure displays epidemic curves using histograms summarizing the incidence rate of infection in the Bay Area among adults 65+ compared to those under 65. Across the entire observation period, adults 65+ consistently experienced higher incidence rates, indicating a disproportionate burden of disease in older populations, regardless of sex or race.

```{r, echo = TRUE}
library(dplyr)
library(ggplot2)
library(lubridate)

bay_data <- combined_data %>%
  filter(health_officer_region == "Bay Area") %>% 
  mutate(age_group = ifelse(age_cat == "65+", "65+", "<65"))

bay_summary <- bay_data %>%
  group_by(dt_diagnosis, age_group) %>% 
  summarise(
    new_infections = sum(new_infections, na.rm = TRUE),
    pop = sum(pop, na.rm = TRUE),
    .groups = "drop") %>%
  mutate(incidence_rate = (new_infections / pop) * 100000)

ggplot(bay_summary, aes(x = dt_diagnosis, y = incidence_rate, fill = age_group)) +
  geom_col(position = "dodge") +
  labs(
    title = "Weekly Incidence Rate of Infection in the Bay Area",
    subtitle = "Comparison between adults 65+ and those under 65 (all races and sexes)",
    x = "Week of Diagnosis",
    y = "Incidence Rate per 100,000 Population",
    fill = "Age Group"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")
```

# VISUALIZATION #2:

This table summarizes the total number of new infections, population size, and incidence rates across Bay Area counties. By comparing incidence per 100,000 residents, it shows which counties are experiencing higher relative infection burdens within the region.

```{r, echo = TRUE}

bay_area_counties <- c(
  "Alameda County", "Contra Costa County", "Marin County", "Napa County", "Monterey County", "San Benito County", "San Francisco County", "San Mateo County", "Santa Clara County", "Santa Cruz County", "Solano County", "Sonoma County")

bay_area_table <- combined_data %>%
  filter(county %in% bay_area_counties) %>%
  group_by(county) %>% 
  summarise(
    total_cases = sum(new_infections, na.rm = TRUE),
    total_population = sum(pop, na.rm = TRUE)
  ) %>%
  mutate(
    incidence_per_100k = (total_cases / total_population) * 100000
  ) %>%
  mutate(
    total_cases = comma(total_cases),
    total_population = comma(total_population),
    incidence_per_100k = comma(round(incidence_per_100k, 1))
  ) %>%
  arrange(county)

kable(
  bay_area_table,
  col.names = c("County", "Total Cases", "Total Population", "Incidence per 100,000"),
  align = "c",
  caption = "Incidence rate per 100,000 in Bay Area counties"
)
```

# VISUALIZATION #3:

In the previous two plots, we explored health officer region wide data analyzing health disparities among age groups and counties. In the third and final plot, we built on those existing visualizations to explore the relationships that race/ethnicity may have on the health outcomes of people in the Bay Area. For purposes of visualization, the data are aggregated by month rather than by week.

```{r, echo = TRUE}
bay_race_plot <- combined_data %>%
  filter(health_officer_region == "Bay Area") %>%
  mutate(month = floor_date(dt_diagnosis, "month")) %>%
  group_by(month, race_ethnicity) %>%
  summarise(
    new_infections = sum(new_infections, na.rm = TRUE),
    total_pop = sum(pop, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(incidence_per_100k = (new_infections / total_pop) * 100000) %>%
  mutate(race_ethnicity = case_when(
    race_ethnicity == "American Indian or Alaska Native, Non-Hispanic" ~ "AI/AN",
    race_ethnicity == "Native Hawaiian or Pacific Islander, Non-Hispanic" ~ "NH/PI",
    race_ethnicity == "Black, Non-Hispanic" ~ "Black",
    race_ethnicity == "Hispanic (any race)" ~ "Hispanic/Latino",
    race_ethnicity == "Asian, Non-Hispanic" ~ "Asian",
    race_ethnicity == "White, Non-Hispanic" ~ "White",
    race_ethnicity == "Multiracial (two or more of above races), Non-Hispanic" ~ "Multiracial",
    TRUE ~ race_ethnicity 
  ))

ggplot(bay_race_plot, aes(x = month, y = incidence_per_100k, fill = race_ethnicity)) +
  geom_col(position = "dodge") +
  labs(
    title = "Monthly Incidence Rate by Race/Ethnicity in the Bay Area",
    x = "Month of Diagnosis",
    y = "Incidence Rate per 100,000",
    fill = "Race/Ethnicity"
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "bottom")
```
