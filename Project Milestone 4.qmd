---
title: "Project Milestone 4"
format: html
editor: visual
---

## **Milestone #4 Objective - Juliana, Daniel**

Visualizations complete.

#### **Milestone #4 Details**

Please submit an Rmd or Qmd and publish an html file on RPubs with the following:

1.  Final datasets for creation of visualization

    -   Join all datasets together

    -   Calculate any remaining data elements needed for analysis

    -   Show code used to create joined dataset, but please do not print full data frame output (showing data structure with `str()` is okay)

```{r libraries, warning=FALSE, message=FALSE}
library(tidyverse)
library(janitor)
library(dplyr)
```

```{r chunk_name, include=FALSE}
ca_pop <- read_csv("ca_pop_2023.csv", 
                   na = c("NA", "N/A", "", "null", "-"))
sim_CA <- read_csv("sim_novelid_CA.csv", 
                   na = c("NA", "N/A", "", "null", "-"))
sim_LA <- read_csv("sim_novelid_LACounty.csv", 
                   na = c("NA", "N/A", "", "null", "-"))

sim_CA <- sim_CA %>% clean_names()
sim_LA <- sim_LA %>% clean_names()

sim_LA <- sim_LA %>%
  rename(dt_diagnosis = dt_dx,
    age_cat = age_category,
    race_ethnicity = race_eth,
    new_infections = dx_new,
    cumulative_infected = infected_cumulative,
    new_unrecovered = unrecovered_new,
    cumulative_unrecovered = unrecovered_cumulative,
    new_severe = severe_new,
    cumulative_severe = severe_cumulative)

sim_CA <- sim_CA %>%
  mutate(dt_diagnosis = as.Date(dt_diagnosis))

sim_LA <- sim_LA %>%
  mutate(dt_diagnosis = as.Date(dt_diagnosis, format = "%d%b%Y"))

sim_CA <- sim_CA %>%
  mutate(
    race_ethnicity = case_when(
      race_ethnicity == 1 ~ "White, Non-Hispanic",
      race_ethnicity == 2 ~ "Black, Non-Hispanic",
      race_ethnicity == 3 ~ "American Indian or Alaska Native, Non-Hispanic",
      race_ethnicity == 4 ~ "Asian, Non-Hispanic",
      race_ethnicity == 5 ~ "Native Hawaiian or Pacific Islander, Non-Hispanic",
      race_ethnicity == 6 ~ "Multiracial (two or more of above races), Non-Hispanic",
      race_ethnicity == 7 ~ "Hispanic (any race)",
      TRUE ~ NA_character_))

sim_LA <- sim_LA %>%
  select(-dt_report)

sim_LA <- sim_LA %>%
  mutate(county = "Los Angeles County")

ca_pop <- ca_pop %>%
  rename(race_ethnicity = race7
    )

ca_pop <- ca_pop %>%
  mutate(county = paste0(county, " County"))
    

ca_pop <- ca_pop %>%
  mutate(
    race_ethnicity = case_when(
      race_ethnicity == "WhiteTE NH" ~ "White, Non-Hispanic",
      race_ethnicity == "Black NH" ~ "Black, Non-Hispanic",
      race_ethnicity == "AIAN NH" ~ "American Indian or Alaska Native, Non-Hispanic",
      race_ethnicity == "Asian NH" ~ "Asian, Non-Hispanic",
      race_ethnicity == "NHPI NH" ~ "Native Hawaiian or Pacific Islander, Non-Hispanic",
      race_ethnicity == "MR NH" ~ "Multiracial (two or more of above races), Non-Hispanic",
      race_ethnicity == "Hispanic" ~ "Hispanic (any race)",
      TRUE ~ NA_character_))

combined_data <- bind_rows(sim_CA, sim_LA)

```

```{r}
str(sim_CA)
str(sim_LA)
str(combined_data)
str(ca_pop)
```

1.  

2.  Visualizations (at least one per group member)

    -   One print quality table as requested in scenario

    -   One print quality plot or chart as requested in scenario

    -   For groups of 3, one additional print quality table or plot of your choice (can support the requested data in the scenario, or answer a different question using the same data sources)

3.  For each visual, include

    -   Code used to generate visual

    -   Legend (if necessary)

    -   1-2 sentence interpretation

    -   NOTE:

        -   Please make sure the visual can stand-alone, meaning it includes enough information in title, legend, and footnote so that a person who sees only the visualization could understand what is being presented.

        -   Please also make sure column names, axis labels, and any other labels are meaningful and not just the name of the variable (ex: "County" rather than "county_name")

4.  Html file that is professionally prepared for presentation and published to RPubs

    -   Only the necessary information is in the output (e.g., suppress entire data frame outputs but showing data structure with `str()` is okay.

    -   Code used to import and clean data (milestones 2 and 3) can be included in the rmd/qmd but please use the option include=FALSE in order to prevent the code and any output from. Code chunk would look like `{r chunk_name, include=FALSE}`{style="font-family: Monaco, Menlo, Consolas, \"Courier New\", monospace; font-size: 0.75rem; border-radius: 6px; background-color: rgb(242, 244, 244); border: 1px solid rgb(232, 234, 236); padding: 0.125rem 0.25rem; color: rgb(199, 31, 35); text-size-adjust: auto;"}

    -   Utilize `warning=FALSE`{style="font-family: Monaco, Menlo, Consolas, \"Courier New\", monospace; font-size: 0.75rem; border-radius: 6px; background-color: rgb(242, 244, 244); border: 1px solid rgb(232, 234, 236); padding: 0.125rem 0.25rem; color: rgb(199, 31, 35); text-size-adjust: auto;"} and `message=FALSE`{style="font-family: Monaco, Menlo, Consolas, \"Courier New\", monospace; font-size: 0.75rem; border-radius: 6px; background-color: rgb(242, 244, 244); border: 1px solid rgb(232, 234, 236); padding: 0.125rem 0.25rem; color: rgb(199, 31, 35); text-size-adjust: auto;"} to suppress any warnings/messages that may be displaying from any chunks

    -   For this milestone please make sure code for visualizations are included in the final file. Show your work by "echoing" code used in Rmd/Qmd file to create your tables and graphs. \`\`\`{r, echo = TRUE} in code chunk preferences.

    -   Use headers and sub headers to create an organized document

    -   Make sure you commit and push your rsconnect folder! [Read more details here.Links to an external site.](https://docs.google.com/document/d/1JSg5JUEI3JDD_rPAlAaVPno0MlUGQ6W_cyBvn6Ud1xs/edit?usp=sharing)

```{r}
ca_pop_collapsed <- ca_pop %>%
  mutate(age_cat = case_when(
    age_cat %in% c("0-4", "5-11", "12-17") ~ "0-17",
    age_cat == "18-49" ~ "18-49",
    age_cat == "50-64" ~ "50-64",
    age_cat == "65+"   ~ "65+",
    TRUE ~ NA_character_
  )) %>%
  group_by(county, health_officer_region, sex, race_ethnicity, age_cat) %>%
  summarise(pop = sum(pop), .groups = "drop")

```

```{r}
str(ca_pop_collapsed)
```

```{r}
combined_data <- combined_data %>% select(-time_int)
```

```{r}
combined_data <- combined_data %>%
  left_join(ca_pop_collapsed,
            by = c("county", "age_cat", "sex", "race_ethnicity"))
str(combined_data)
```

```{r}
combined_data <- combined_data %>%
  mutate(
    rate_infection = (new_infections / pop) * 100000,
    rate_unrecovered = (new_unrecovered / pop) * 100000,
    rate_severe = (new_severe / pop) * 100000,
    rate_cum_infection = (cumulative_infected / pop) * 100000,
    rate_cum_unrecovered = (cumulative_unrecovered / pop) * 100000,
    rate_cum_severe = (cumulative_severe / pop) * 100000)
str(combined_data)
```

```{r}
combined_data <- combined_data %>%
  mutate(across(starts_with("rate"), ~ round(.x, 2)))

```

```{r}
library(dplyr)
library(ggplot2)
library(lubridate)

# Filter Bay Area + create <65 group
bay_data <- combined_data %>%
  filter(health_officer_region == "Bay Area") %>% 
  mutate(age_group = ifelse(age_cat == "65+", "65+", "<65"))

# Aggregate across sex and race
bay_summary <- bay_data %>%
  group_by(dt_diagnosis, age_group) %>% 
  summarise(
    new_infections = sum(new_infections, na.rm = TRUE),
    pop = sum(pop, na.rm = TRUE),
    .groups = "drop") %>%
  mutate(incidence_rate = (new_infections / pop) * 100000)

# Plot
ggplot(bay_summary, aes(x = dt_diagnosis, y = incidence_rate, color = age_group)) +
  geom_line(linewidth = 1.1) +
  scale_color_manual(values = c("65+" = "blue", "<65" = "green"),
                     name = "Age Group") +
  labs(
    title = "Weekly Incidence Rate of Infection in the Bay Area",
    subtitle = "Comparison between adults 65+ and those under 65 (all races and sexes)",
    x = "Week of Diagnosis",
    y = "Incidence Rate per 100,000 Population" 
    ) + 
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "bottom"
  )
```

For the first figure, we plotted the weekly incidence rate of the disease in the Bay Area, comparing populations aged 65+ versus those under 65, across all races and sexes.
